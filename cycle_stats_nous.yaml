- trigger:
    # DÉMARRAGE DU CYCLE (Puissance > 5W pendant 10 sec)
    - platform: numeric_state
      entity_id: sensor.multi_nous_power
      above: 5
      for: "00:00:10"
      id: "start"
    
    # FIN DU CYCLE (Puissance < 2W pendant 5 min)
    - platform: numeric_state
      entity_id: sensor.multi_nous_power
      below: 2
      for: "00:05:00"
      id: "stop"
    
    # MISE À JOUR (Chaque changement de puissance, tension ou courant)
    - platform: state
      entity_id: 
        - sensor.multi_nous_power
        - sensor.multi_nous_voltage
        - sensor.multi_nous_current
      id: "update"

  sensor:
    - name: "Nous A11Z - Stats Cycle"
      unique_id: nous_a11z_stats_cycle
      icon: mdi:chart-box-outline
      state: >
        {% if trigger.id == 'start' %}
          En cours
        {% elif trigger.id == 'stop' %}
          Terminé
        {% else %}
          {{ states('sensor.nous_a11z_stats_cycle') }}
        {% endif %}
      
      attributes:
        # --- COMPTEUR ECHANTILLONS (Pour moyennes) ---
        scan_count: >
          {% if trigger.id == 'start' %}
            0
          {% else %}
            {{ this.attributes.scan_count | default(0) | int + 1 }}
          {% endif %}

        # --- TEMPS ---
        start_time: >
          {% if trigger.id == 'start' %}
            {{ now().isoformat() }}
          {% else %}
            {{ this.attributes.start_time | default(now().isoformat()) }}
          {% endif %}
        
        end_time: >
          {% if trigger.id == 'start' %}
            None
          {% elif trigger.id == 'stop' %}
            {{ now().isoformat() }}
          {% else %}
            {{ this.attributes.end_time | default('None') }}
          {% endif %}
        
        duration: >
          {% if this.attributes.start_time is defined and this.attributes.start_time != 'None' %}
            {% set start = as_datetime(this.attributes.start_time) %}
            {% set end = now() if trigger.id != 'stop' else as_datetime(now().isoformat()) %}
            {{ (end - start).total_seconds() | int }}
          {% else %}
            0
          {% endif %}

        # --- ENERGIE ---
        initial_energy: >
          {% if trigger.id == 'start' %}
            {{ states('sensor.multi_nous_energy') | float(0) }}
          {% else %}
            {{ this.attributes.initial_energy | default(states('sensor.multi_nous_energy') | float(0)) }}
          {% endif %}
        
        energy_consumed: >
          {% set current = states('sensor.multi_nous_energy') | float(0) %}
          {% set initial = this.attributes.initial_energy | default(current) | float(0) %}
          {{ (current - initial) | round(3) }}
        
        # ====================================================
        # STATISTIQUES (Min > 0 / Max / Avg)
        # ====================================================

        # --- POWER (W) ---
        avg_power: >
          {# Methode Energie / Temps (Plus précis pour la puissance) #}
          {% set energy = this.attributes.energy_consumed | default(0) | float(0) %}
          {% set duration = this.attributes.duration | default(0) | float(0) %}
          {% if duration > 10 %}
            {{ ((energy * 1000) / (duration / 3600)) | round(1) }}
          {% else %}
            {{ states('sensor.multi_nous_power') | float(0) }}
          {% endif %}

        max_power: >
          {% set val = states('sensor.multi_nous_power') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val }}
          {% else %}
            {{ [val, this.attributes.max_power | default(0) | float] | max }}
          {% endif %}

        min_power: >
          {% set val = states('sensor.multi_nous_power') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val if val > 0 else 9999 }}
          {% else %}
            {% set current_min = this.attributes.min_power | default(9999) | float %}
            {% if val > 0 %}
              {{ [val, current_min] | min }}
            {% else %}
              {{ current_min }}
            {% endif %}
          {% endif %}

        # --- VOLTAGE (V) ---
        avg_voltage: >
          {# Moyenne glissante : avg_new = avg_old + (val - avg_old) / count #}
          {% set val = states('sensor.multi_nous_voltage') | float(0) %}
          {% set count = this.attributes.scan_count | default(0) | int %}
          {% if trigger.id == 'start' or count <= 1 %}
            {{ val }}
          {% else %}
            {% set old_avg = this.attributes.avg_voltage | default(val) | float %}
            {{ (old_avg + (val - old_avg) / count) | round(1) }}
          {% endif %}

        max_voltage: >
          {% set val = states('sensor.multi_nous_voltage') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val }}
          {% else %}
            {{ [val, this.attributes.max_voltage | default(0) | float] | max }}
          {% endif %}

        min_voltage: >
          {% set val = states('sensor.multi_nous_voltage') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val if val > 0 else 250 }}
          {% else %}
            {% set current_min = this.attributes.min_voltage | default(250) | float %}
            {% if val > 0 %}
              {{ [val, current_min] | min }}
            {% else %}
              {{ current_min }}
            {% endif %}
          {% endif %}

        # --- CURRENT (A) ---
        avg_current: >
          {# Moyenne glissante #}
          {% set val = states('sensor.multi_nous_current') | float(0) %}
          {% set count = this.attributes.scan_count | default(0) | int %}
          {% if trigger.id == 'start' or count <= 1 %}
            {{ val }}
          {% else %}
            {% set old_avg = this.attributes.avg_current | default(val) | float %}
            {{ (old_avg + (val - old_avg) / count) | round(2) }}
          {% endif %}

        max_current: >
          {% set val = states('sensor.multi_nous_current') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val }}
          {% else %}
            {{ [val, this.attributes.max_current | default(0) | float] | max }}
          {% endif %}

        min_current: >
          {% set val = states('sensor.multi_nous_current') | float(0) %}
          {% if trigger.id == 'start' %}
            {{ val if val > 0 else 99 }}
          {% else %}
            {% set current_min = this.attributes.min_current | default(99) | float %}
            {% if val > 0 %}
              {{ [val, current_min] | min }}
            {% else %}
              {{ current_min }}
            {% endif %}
          {% endif %}
